pico-8 cartridge // http://www.pico-8.com
version 42
__lua__
function _init()
	pl={
		ani=64,
		x=60,
		y=80,
		spd=1.0
	}
	
	mobs={}
	
	--⬅️: 1,5,9
	--➡️: 2,6,10
	--⬆️: 4,5,6
	--⬇️: 8,9,10
	dirx={-1,1,0, 0,-1, 1,0,0,-1,1}
	diry={ 0,0,0,-1,-1,-1,0,1, 1,1}
	dirx[0]=0
	diry[0]=0
end

function _draw()
	local c=flr((time()*2)%2)
	cls(3)
	map()
	
	spr(pl.ani+c,pl.x,pl.y)
	
	--enemies
	palt(0,false)
	palt(3,true)	
	for m in all(mobs) do
		sspr(0,40+(c*4),8,3,m.x,m.y)
	end
	palt()
	
	print(#mobs,5,5,7)
end

function _update()
	local d=btn()&0b1111
	local dx,dy=dirx[d]*pl.spd,diry[d]*pl.spd	
	pl.x,pl.y=try_move(pl.x,pl.y,dx,dy)
	
	for m in all(mobs) do
		local d=dist(pl.x,pl.y,m.x,m.y)
		local vx=(pl.x-m.x)/d*m.spd
		local vy=(pl.y-m.y)/d*m.spd
		local nx,ny=try_move(m.x,m.y,vx,vy)
		if not is_occupied(m,nx,ny) then
			m.x=nx
			m.y=ny
		end
	end
	
	if #mobs<50 then
		if flr(time()*100%50)==0 then
			spawnmob()
		end
	end
	
end

function try_move(x,y,dx,dy)
	local nx,ny=x+dx,y+dy
	if not is_solid(nx,ny) then
		return nx,ny
	elseif not is_solid(x,ny) then
		return x,ny
	elseif not is_solid(nx,y) then
		return nx,y
	end
	return x,y
end

function is_solid(x,y,flag) 
	flag=flag or 0
	if (fget(mget(flr(x/8),flr(y/8)),flag)) return true
	if (fget(mget(flr((x+7)/8),flr(y/8)),flag)) return true
	if (fget(mget(flr(x/8),flr((y+7)/8)),flag)) return true
	if (fget(mget(flr((x+7)/8),flr((y+7)/8)),flag)) return true
	return false
end

function is_occupied(m,nx,ny)
	for o in all(mobs) do
		if o!=m and dist(nx,ny,o.x,o.y)<8 then return true end
	end
	return false
end

function spawnmob()
	local r=rnd(512)
	local p=r%128
	local e=flr(r/128)
	local x,y=0,0
	if e==0 then
		x=0
		y=p
	elseif e==1 then
		x=128
		y=p
	elseif e==2 then
		y=0
		x=p
	elseif e==3 then
		y=128
		x=p
	end
	local mob={
		x=x,
		y=y,
		ani=80,
		spd=0.6
	}
	if not is_occupied(mob,x,y) then
		add(mobs,mob)
	end
	return mob
end
-->8
--tools

function dist(x1,y1,x2,y2)
	local dx,dy=x1-x2,y1-y2
	return sqrt(dx*dx+dy*dy)
end
__gfx__
00000000333333333333333300000000000000000000000000000000000000000044444444444444444444000000000000000000000000000000000000000000
0000000033333333333333b300000000000000000606060606060606060606000455555555555555555555400000000000000000000000000000000000000000
007007003b333b333b33333300000000000000006666666666666666666666604599999999999999999999540000000000000000000000000000000000000000
00077000333333333333333300000000000000000606060606060606b60606004999999999999999999999940000000000000000000000000000000000000000
00077000333333b33333b33300000000000000000606060606060606060606004999999999999999999999940000000000000000000000000000000000000000
00700700333333333333333300000000000000006666666666666666666666604999999999999999999999940000000000000000000000000000000000000000
00000000333b33333333333300000000000000000606060606060606060606004999999999999999999999940000000000000000000000000000000000000000
000000003333333333b3333300000000000000000655555555555555555556504999999999999999999999940000000000000000000000000000000000000000
00000000000000000000000000000000000000000650000033333333000056004999999999999999999999940000000000000000000000000000000000000000
00000000000000000000000000000000000000000650b000333333330b0056004999999999999999999999940000000000000000000000000000000000000000
00000000000000000000000000000000000000006660000033333333000066604999999999999999999999940000000000000000000000000000000000000000
0000000000000000000000000000000000000000065000b033333333000056004999999999999999999999940000000000000000000000000000000000000000
00000000000000000000000000000000000000000650000033333333030b56004999999999999999999999940000000000000000000000000000000000000000
00000000000000000000000000000000000000006660000033333333000066604999999999999999999999940000000000000000000000000000000000000000
000000000000000000000000000000000000000006500000333333330b0056004999999999999999999999940000000000000000000000000000000000000000
00000000000000000000000000000000000000000650b00033333333000056004999999999999999999999940000000000000000000000000000000000000000
00000000000000000000000000000000000000000650000000000000000056004999999999999999999999940000000000000000000000000000000000000000
00000000000000000000000000000000000000000656060606060606060656004999999999999999999999940000000000000000000000000000000000000000
00000000000000000000000000000000000000006666666666666666666666604999999999999999999999940000000000000000000000000000000000000000
00000000000000000000000000000000000000000656060606060606060656004999999999999999999999940000000000000000000000000000000000000000
00000000000000000000000000000000000000000656060606060606060656004999999999999999999999940000000000000000000000000000000000000000
00000000000000000000000000000000000000006666666666666666666666604999999999999999999999940000000000000000000000000000000000000000
00000000000000000000000000000000000000000656060606060606060656004999999999999999999999940000000000000000000000000000000000000000
00000000000000000000000000000000000000000055555555555555555555009444444444444444444444490000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000004499999999999999999999440000000000000000000000000000000000000000
00444400000000000000000000000000000000000000000000000000000000009499999994444449999999490000000000000000000000000000000000000000
05444450000777000000000000000000000000000000000000000000000000004499999994666649999999440000000000000000000000000000000000000000
04555540077666600000000000000000000000000000000000000000000000009499999994555549999999490000000000000000000000000000000000000000
44444444766666650000000000000000000000000000000000000000000000004499999999999999999999440000000000000000000000000000000000000000
54455454766666650000000000000000000000000000000000000000000000005555555555555555555555550000000000000000000000000000000000000000
0445045456666650000000000000000000000000000000000000000000000000333b333333333333333b33330000000000000000000000000000000000000000
04500400055555000000000000000000000000000000000000000000000000003333333333b33333333333330000000000000000000000000000000000000000
00001110000001110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000ff100000011100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000ff100000ff1000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00111100000ff1000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0011c1000011c1000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00111c00001c11000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
01111100011111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
04404400004404000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
30033003000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
05500550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
33300333000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
33333333000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
33300333000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
30000003000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
05533550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
33333333000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0000000000010101010101000000000000000000000100010101010000000000000000000001010101010100000000000101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101
0101010101010101020201010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101
0000000000000002020002000000000031000000000000000000000101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101
0000020000000002000031000000000000000000000000000000000000000001010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101
0000003100000000000000000000000000000000000000000000000000000201010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101
0000000000000000000000000031000000000002000506060606070000000001010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101
0000000202020809090a02000000000000000000001501010101170000000001010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101
0000050606061819191a06060607000000000000001501010101170000000001010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101
0000000000002829292a00000000000000000000001501010101170000000001010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101
0000000200003839393a02000000000000000000001501010101170000000001010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101
0031000000000000000000000200000000020200002526262626270000000001010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101
0000000000000000000000000000020202000000000000000000000000000001010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101
0000000000000000000002020002000000000000000000000000000101010101010201010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101
0000003000000002020200300000000000000000000000000200000101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101
0000000000000000000000000000000000000000000000000000000101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101
0030000000310000003000000030000000000000000000000000000101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101
0000000000000000000000000000000000000000000000000000000101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101
0000000000000000000200000000000000000000000000000000000101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101
0000000000000000000000000000000002000000000000000000000101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101
0101010101010101010101010101010102020101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101
0101010101020101010101010101010101010201010101010101010102010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101
0101010101010101010101010101010101010201010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101
0101010101010101010101010101010101010102010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101
0101010101010101010101010101010101010101020101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101
0101010101010101010101010101020101010101020101010101010101020101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101
0101010101010201010102010101010101010101010101010101010101020101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101
0101010101010101010101010101010101010101010101010101010102020101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101
0101010101010101010101010101010101010101010102020202020202010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101
0101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101
0101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101
0101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101
0101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101
